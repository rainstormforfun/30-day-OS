# 第3天 进入32位模式并导入C语言

## 制作真正的IPL

这次我们将使用**启动区**装载程序。

```nasm title="ipl.nas"
; haribote-ipl
; TAB=4

	ORG    0x7c00
	JMP    entry
	DB     0x90
	DB     "HARIBOTE"
	DW     512
	DB     1
	DW     1
	DB     2
	DW     224
	DW     2880
	DB     0xf0
	DW     9
	DW     18
	DW     2
	DD     0
	DD     2880
	DB     0,0,0x29
	DD     0xffffffff
	DB     "HARIBOTEOS "
	DB     "FAT12   "
	RESB   18

entry:
	MOV    AX,0
	MOV    SS,AX
	MOV    SP,0x7c00
	MOV    DS,AX

	MOV    AX,0x0820
	MOV    ES,AX
	MOV    CH,0         ; 柱面0
	MOV    DH,0         ; 磁头0
	MOV    CL,2         ; 扇区2
	MOV    AH,0x02      ; 读盘
	MOV    AL,1         ; 1个扇区
	MOV    BX,0
	MOV    DL,0x00      ; A驱动器
	INT    0x13         ; 调用磁盘BIOS
	JC     error
```

- `JC`: jump if carry。如果进位标志(carry flag)是1，就跳转。
- **标志**：1位寄存器

### `INT 0x13`

- 磁盘读、写，扇区校验，以及寻道
	- `AH=0x02` 读盘
	- `AH=0x03` 写盘
	- `AH=0x04` 校验
	- `AH=0x0c` 寻道
	- `AL=处理对象的扇区数(只能同时处理连续的扇区)`
	- `CH=柱面号 &0xff`
	- `CL=扇区号(0-5位) | (柱面号&0x300)**2`
	- `DH=磁头号`
	- `DL=驱动器号`
	- `ES:BX=缓冲地址(校验及寻道时不使用)`
	- 返回值：
	- `FLAGS.CF==0` 没有错误，`AH==0`
	- `FLAGS.CF==1` 有错误，错误号码存入`AH`内(与重置功能一样)

1张软盘有80个柱面，2个磁头，18个扇区，一个扇区有512字节。

含有IPL的启动区，位于`C0-H0-S1`(柱面0，磁头0，扇区1)

下一个扇区是`C0-H0-S2`

### 缓冲地址

 这是个内存地址，==表明我们要把从软盘上读出的数据装载到内存中的哪个位置。==

如果能用一个寄存器来表示内存地址的话，很方便，但是一个`BX`只能表示`0~0xffff`(16位)，也就是只有`0~65535`。

$$65535 \div 2^{10} = 63.999$$

最大才64K。但是电脑最起码也都有64M内存。

#### 段寄存器

我们在使用段寄存器时，以`ES:BX`这种方式来表示地址，写成
```nasm
MOV AL,[ES:BX]
```
它代表`ES*16+BX`的内存地址。我们可以理解成，==先用`ES`寄存器指定一个大致的地址，然后再用`BX`来指定其中一个具体地址==。这样就是$65535\times 17 =1114095字节=1087.983KB$，这就可以指定1M以内的内存了。

这次`ES=0x0820, BX=0`，所以软盘的数据将被装载到内存中`0x8200`到`0x83ff`。`0x8000~0x81ff`，要把启动区的内容读到那里。`0x7c00~0x7dff`用于启动区，`0x7e00~0x9fbff`没有特别的用途，操作系统可以随意使用。

#### 默认的段寄存器 `DS:`

```nasm
MOV  CX,[1234]
; 其实是
MOV  CX,[DS:1234]
```

**因为有这样的规则，所以`DS`必须预先设置为0**

### 使用变量的Makefile

```makefile
TOOLPATH = ../z_tools/
MAKE     = $(TOOLPATH)make.exe -r
NASK     = $(TOOLPATH)nask.exe
EDIMG    = $(TOOLPATH)edimg.exe
IMGTOL   = $(TOOLPATH)imgtol.com
COPY     = copy
DEL      = del

default :
	$(MAKE) img

ipl.bin : ipl.nas Makefile
	$(NASK) ipl.nas ipl.bin ipl.lst

haribote.img : ipl.bin Makefile
	$(EDIMG) imgin:../z_tools/fdimg0at.tek wbinimg src:ipl.bin len:512 from:0 to:0 imgout:haribote.img

asm : 
	$(MAKE) ipl.bin

img :
	$(MAKE) haribote.img

run :
	$(MAKE) img
	$(COPY) haribote.img ..\z_tools\qemu\fdimage0.bin
	$(MAKE) -C ../z_tools/qemu

install :
	$(MAKE) img
	$(IMGTOL) w a:haribote.img

clean :
	-$(DEL) ipl.bin
	-$(DEL) ipl.lst

src_only :
	$(MAKE) clean
	-$(DEL) haribote.img
```

## 试错

如果软盘不能读数据，我们决定重试5次。

```nasm title="ipl.nas"
; haribote-ipl
; TAB=4
	ORG    0x7c00
	JMP    entry
	DB     0x90
	DB     "HARIBOTE"
	DW     512
	DB     1
	DW     1
	DB     2
	DW     224
	DW     2880
	DB     0xf0
	DW     9
	DW     18
	DW     2
	DD     0
	DD     2880
	DB     0,0,0x29
	DD     0xffffffff
	DB     "HARIBOTEOS "
	DB     "FAT12   "
	RESB   18

entry:
	MOV    AX,0
	MOV    SS,AX
	MOV    SP,0x7c00
	MOV    DS,AX
	MOV    AX,0x0820
	MOV    ES,AX
	MOV    CH,0        ; 柱面0
	MOV    DH,0        ; 磁头0
	MOV    CL,2        ; 扇区2
	MOV    SI,0        ; 记录失败次数的寄存器

retry:
	MOV    AH,0x02
	MOV    AL,1
	MOV    BX,0
	MOV    DL,0x00     ; A驱动器
	INT    0x13        ; 调用磁盘BIOS
	JNC    fin         ; 没出错的话跳转到fin 
	ADD    SI,1
	CMP    SI,5
	JAE    error       ; SI>=5时，跳转到error
	MOV    AH,0x00
	MOV    DL,0x00     ; A驱动器
	INT    0x13        ; 重置驱动器
	JMP    retry

fin:
	HLT
	JMP    fin

error:
	MOV    SI,msg

putloop:
	MOV    AL,[SI]
	ADD    SI,1
	CMP    AL,0
	JE     fin
	MOV    AH,0x0e
	MOV    BX,15
	INT    0x10
	JMP    putloop

msg:
	DB     0x0a,0x0a
	DB     "load error"
	DB     0x0a
	DB     0
	RESB   0x7dfe-$
	DB     0x55,0xaa
```

- `JNC`: jump if not carry。进位标志是0的话就跳转。
- `JAE`: jump if above or equal。大于或等于时跳转。
- `AH=0x00, DL=0x00, INT 0x13`这是系统复位。

### 读到18扇区

```nasm title="ipl.nas"
	ORG    0x7c00
	JMP    entry
	DB     0x90
	DB     "HARIBOTE"
	DW     512
	DB     1
	DW     1
	DB     2
	DW     224
	DW     2880
	DB     0xf0
	DW     9
	DW     28
	DW     2
	DD     0
	DD     2880
	DB     0,0,0x29
	DD     0xffffffff
	DB     "HARIBOTEOS"
	DB     "FAT12   "
	RESB   18

```