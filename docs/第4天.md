
# ç¬¬4å¤© Cè¯­è¨€ä¸ç”»é¢æ˜¾ç¤ºçš„ç»ƒä¹ 

## ç”¨Cè¯­è¨€å®ç°å†…å­˜å†™å…¥

æƒ³è¦ç”»ä¸œè¥¿çš„è¯ï¼Œåªè¦å¾€`VRAN`é‡Œå†™ç‚¹ä»€ä¹ˆå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨Cè¯­è¨€ä¸­åˆæ²¡æœ‰ç›´æ¥å†™å…¥æŒ‡å®šå†…å­˜åœ°å€çš„è¯­å¥ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¹²è„†å°±åˆ›å»ºä¸€ä¸ªæœ‰è¿™ç§åŠŸèƒ½çš„å‡½æ•°ã€‚

```nasm title="naskfunc.nas"
[FORMAT "WCOFF"]
[INSTRSET "i486p"]         ; è¿™ä¸ªç¨‹åºæ˜¯ç»™486CPUç”¨çš„
[BITS 32]
[FILE "naskfun.nas"]

	GLOBAL _io_hlt,_write_mem8

[section .text]

_io_hlt:
	HLT
	RET

_write_mem8:
	MOV    ECX,[ESP+4]     ; [ESP+4]ä¸­å­˜æ”¾çš„æ˜¯åœ°å€ï¼Œå°†å…¶è¯»å…¥ECX
	MOV    AL,[ESP+8]      ; [ESP+8]ä¸­å­˜æ”¾çš„æ˜¯æ•°æ®ï¼Œå°†å…¶è¯»å…¥ALL
	MOV    [ECX],AL
	RET
```

æ•°å­—çš„å­˜æ”¾åœ°å€ï¼š`[ESP+4]`, `[ESP+8]`, `[ESP+12]`...

å¦‚æœä¸Cè¯­è¨€è”åˆä½¿ç”¨çš„è¯ï¼Œèƒ½è‡ªç”±ä½¿ç”¨çš„å¯„å­˜å™¨åªæœ‰`EAX`, `ECX`ï¼Œ`EDX`ã€‚å…¶ä»–å¯„å­˜å™¨åªèƒ½ä½¿ç”¨å…¶å€¼ï¼Œä¸èƒ½æ”¹å˜å…¶å€¼

```c title="bootpack.c"
void io_hlt(void);
void write_mem8(int addr, int data);

void HariMain(void)
{
	int i;
	for (i = 0xa0000; i <= 0xaffff; i++)
	{
		write_mem8(i,15);	
	}

	for(;;)
	{
		io_hlt();	
	}
}
```

![image.png](https://vs-picbed-1320307070.cos.ap-nanjing.myqcloud.com/img/20240223132759.png)

## æ¡çº¹å›¾æ¡ˆ

```c title="bootpack.c"
void io_hlt(void);
void write_mem8(int addr, int data);

void HariMain(void)
{
	int i;
	for (i = 0xa0000; i <= 0xaffff; i++)
	{
		write_mem8(i, i & 0x0f);
	}

	for (;;)
	{
		io_hlt();	
	}
}
```

- `&`ï¼šä¸è¿ç®—(AND)

ä»`0~F`å¾ªç¯ã€‚

![image.png](https://vs-picbed-1320307070.cos.ap-nanjing.myqcloud.com/img/20240223144537.png)

### æŒ‘æˆ˜æŒ‡é’ˆ

å¾ˆæ˜æ˜¾ï¼Œ`write_mem8`å¯ä»¥ç”¨æŒ‡é’ˆä»£æ›¿ğŸ˜ã€‚

```c
write_mem8(i, i & 0x0f);
```

æ›¿ä»£ä»¥ä¸Šè¯­å¥çš„æ˜¯ï¼š

```c
i = i & 0x0f;
```

ä½†æ˜¯ï¼Œä¼šå‡ºé”™ï¼š

```txt
invalid type argument of 'unary *'
```

æˆ‘ä»¬ä»ç¼–è¯‘å™¨çš„è§’åº¦ç¨å¾®æƒ³æƒ³å°±èƒ½æ˜ç™½ä¸ºä»€ä¹ˆä¼šå‡ºé”™äº†ã€‚

```nasm
MOV    [0x1234],0x56
```

è¿™ç§æƒ…å†µä¹Ÿä¼šå‡ºé”™ã€‚è¿™æ˜¯å› ä¸ºæŒ‡å®šå†…å­˜æ—¶ï¼Œä¸çŸ¥é“åˆ°åº•æ˜¯`BYTE`ï¼Œè¿˜æ˜¯`WORD`ï¼Œè¿˜æ˜¯`DWORD`ã€‚**_åªæœ‰åœ¨å¦ä¸€æ–¹ä¹Ÿæ˜¯å¯„å­˜å™¨çš„æ—¶å€™æ‰èƒ½çœç•¥ï¼Œå…¶ä»–æƒ…å†µéƒ½ä¸èƒ½çœç•¥_**ã€‚

è¿™æ¬¡ï¼Œæˆ‘ä»¬è´¹åŠ²å†™çš„Cè¯­è¨€è¯­å¥ï¼Œç›¸å½“äºä¸‹é¢çš„æ±‡ç¼–è¯­å¥ï¼š

```nasm
MOV    [i],(i & 0x0f)
```

ä½†æ˜¯å´ä¸çŸ¥é“`[i]`åˆ°åº•æ˜¯`BYTE`, è¿˜æ˜¯`WORD`, è¿˜æ˜¯`DWORD`ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ï¼š

```c
char *p;          //ç”¨äºå­˜æ”¾BYTEç±»åœ°å€
p = i & 0x0f;
```

åŒç†ï¼š

```c
char *p;       //ç”¨äºBYTEç±»åœ°å€ï¼Œç›¸å½“äºAL
short *p;      //ç”¨äºWORDç±»åœ°å€ï¼Œç›¸å½“äºAX
int *p;        //ç”¨äºDWORDç±»åœ°å€ï¼Œç›¸å½“äºEAX
```

ä½†æ˜¯æ— è®ºä»€ä¹ˆæƒ…å†µï¼Œå˜é‡`p`éƒ½æ˜¯4å­—èŠ‚ã€‚è¿™æ˜¯å› ä¸ºå˜é‡`p`æ˜¯ç”¨äºè®°å½•åœ°å€çš„å˜é‡ã€‚åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œåœ°å€ä¹Ÿåƒ`ECX`ä¸€æ ·ï¼Œç”¨4å­—èŠ‚çš„å¯„å­˜å™¨æ¥æŒ‡å®šï¼Œæ‰€ä»¥ä¹Ÿæ˜¯4å­—èŠ‚ã€‚

```c title="bootpack.c"
void io_hlt(void);

void HariMain(void)
{
	int i;
	char *p;

	for (i = 0xa0000; i <= 0xaffff; i++)
	{
		p = i;
		*p = i & 0x0f;	
	}

	for (;;)
	{
		io_hlt();	
	}
}
```

### ç±»å‹è½¬æ¢

`make run`ä¹‹åï¼Œä¸”æ…¢ï¼ğŸ˜®å‘ç°æœ‰ä¸€è¡Œè­¦å‘Šï¼š

```txt
warning: assignment makes pointer from integer without a cast
```

åœ¨Cè¯­è¨€ä¸­ï¼Œæ™®é€šæ•°å€¼å’Œè¡¨ç¤ºå†…å­˜åœ°å€çš„æ•°å€¼è¢«è®¤ä¸ºæ˜¯ä¸¤ç§ä¸åŒçš„ä¸œè¥¿ï¼Œè™½ç„¶äº‹å®ä¸Šæ²¡ä»€ä¹ˆä¸åŒã€‚

åŸºäºè¿™ç§è®¾è®¡æ€æƒ³ï¼Œå¦‚æœå°†æ™®é€šæ•´æ•°å€¼èµ‹ç»™å†…å­˜åœ°å€å˜é‡ï¼Œå°±ä¼šæœ‰è­¦å‘Šã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```c 
p = (char*) i;
```

### ä½¿ç”¨ç±»å‹è½¬æ¢å°±å¯ä»¥ä¸ç”¨æŒ‡é’ˆ

```c
p = (char*) i;
*p = i & 0x0f;
```

è¿™æ ·å°±å¾—åˆ°ä¸‹å¼ï¼š

```c
*((char*)i) = i & 0x0f;
```

è¿™ç§å†™æ³•å°±ä¸æ±‡ç¼–è¯­è¨€ç›¸åƒï¼š

```nasm
MOV    BYTE [i], i & 0x0f
```

ä¸‹é¢å†ç¨å¾®æ·±å…¥è¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¸¸è§çš„ä¸¤ä¸ªè¯­å¥æ˜¯ï¼š

```c
p = (char*) i;
*p = i & 0x0f
```

å°†ä¸Šé¢çš„è¯­å¥æŒ‰æ±‡ç¼–çš„ä¹ æƒ¯å†™ä¸€ä¸‹ï¼š

```nasm
MOV    ECX,i
MOV    [ECX],(i & 0x0f)
```

å®ƒä»¬çš„åŒºåˆ«å¾ˆæ¸…æ¥šï¼Œå³ä¸€ä¸ªæ˜¯ç»™`ECX`å¯„å­˜å™¨èµ‹å€¼ï¼Œä¸€ä¸ªæ˜¯ç»™`[ECX]`å·å†…å­˜åœ°å€èµ‹å€¼ã€‚

å¦‚æœæ‰§è¡Œé¡ºåºè°ƒè¿‡æ¥ï¼š

```c
*p = i & 0x0f;
p = (char*) i;
```

è¿™ä¼šå¯¼è‡´`i & 0x0f`çš„ç»“æœå†™å…¥å†…å­˜çš„æŸä¸ªä¸å¯çŸ¥çš„åœ°å€ä¸­ã€‚

å…¶å®ï¼Œ`*p`å¹¶ä¸æ˜¯ä»€ä¹ˆå˜é‡ï¼Œå˜é‡åªæœ‰`p`ã€‚æ‰€è°“`*p`ï¼Œå°±ç›¸å½“äº`BYTE [p]`è¿™ç§è¯­å¥çš„ä»£æ›¿ã€‚

### `*`çš„ä½ç½®

ä¸€èˆ¬çš„å†™æ³•æ˜¯ï¼š

```c
char *p;
```

è™½ç„¶**æˆ‘ä»¬å£°æ˜çš„æ˜¯å˜é‡`p`**ï¼Œå†™æˆè¿™æ ·ä¹Ÿå¯¹ï¼š

```c
char* p;
```

ä½†æ˜¯

```c
char* p, q;
```

`q`ä¼šè¢«çœ‹ä½œæ˜¯ä¸€èˆ¬1å­—èŠ‚çš„å˜é‡ï¼Œä¸ºäº†é¿å…è¿™æ ·çš„è¯¯è§£ï¼Œç¨‹åºå‘˜éƒ½å†™æˆï¼š

```c
char *p, *q;
```

### ä¸å¿…çœ‹ä½œæŒ‡é’ˆ

`char *p;`ä¸å¿…çœ‹ä½œæŒ‡é’ˆã€‚`p`ä¸æ˜¯æŒ‡é’ˆï¼Œè€Œæ˜¯åœ°å€å˜é‡ï¼Œè¿™ç§è¯´æ³•æ¯”è¾ƒå¥½ï¼Œ==å°†åœ°å€å€¼èµ‹ç»™åœ°å€å˜é‡æ˜¯ç†æ‰€å½“ç„¶çš„==ã€‚

## æŒ‡é’ˆçš„åº”ç”¨(1)

ç»˜åˆ¶æ¡çº¹å›¾æ¡ˆçš„éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥å†™æˆä»¥ä¸‹è¿™æ ·ï¼š

```c
void io_hlt(void);

void HariMain(void)
{
	int i;
	char *p;

	p = (char *) 0xa0000;

	for (i = 0; i <= 0xffff; i++)
	{
		*(p + 1) = i & 0x0f;	
	}
}
```

## æŒ‡é’ˆçš„åº”ç”¨(2)

Cè¯­è¨€ä¸­ï¼Œ`*(p + i)`è¿˜å¯ä»¥æ”¹å†™æˆ`p[i]`è¿™ç§å½¢å¼ã€‚

```c
void io_hlt(void);

void HariMain(void)
{
	int i;
	char *p;

	p = (char *) 0xa0000;

	for (i = 0; i <= 0xffff; i++)
	{
		p[i] = i & 0x0f;	
	}
}
```

åè¿‡æ¥è¯´ï¼Œä¹Ÿå¯ä»¥å°†`p[0]`å†™æˆ`*p`ï¼Œä¸¤ç§å†™æ³•ç”Ÿæˆçš„æœºå™¨è¯­è¨€å®Œå…¨ä¸€æ ·ã€‚

åŒç†å¯å¾—`a[2]`å’Œ`2[a]`ğŸ˜ã€‚

## è‰²å·è®¾å®š

è¿™æ¬¡ä½¿ç”¨çš„æ˜¯`320x200`çš„8ä½é¢œè‰²æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åªèƒ½ä½¿ç”¨`0~255`çš„æ•°ã€‚ç†Ÿæ‚‰ç”µè„‘é¢œè‰²çš„äººéƒ½çŸ¥é“ï¼Œè¿™æ˜¯éå¸¸å°‘çš„ã€‚ä¸€èˆ¬è¯´èµ·æŒ‡å®šé¢œè‰²ï¼Œéƒ½æ˜¯ç”¨`#ffffff`ä¸€ç±»çš„æ•°ï¼Œ**è¿™å°±æ˜¯`RGB`æ–¹å¼ã€‚**

å¦‚æœåƒç°åœ¨è¿™æ ·ï¼Œç¨‹åºå‘˜ä¸åšä»»ä½•è®¾å®šï¼Œ0å·é¢œè‰²å°±æ˜¯`#000000`ï¼Œ15å·é¢œè‰²å°±æ˜¯`#ffffff`ã€‚

è¦æƒ³æç»˜ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ‘¸æ ·çš„ç”»é¢ï¼Œåªè¦æœ‰ä»¥ä¸‹è¿™16ç§é¢œè‰²å°±å¤Ÿäº†ï¼š

```txt
#000000 é»‘
#00ffff æµ…äº®è“
#000084 æš—è“
#ff0000 äº®çº¢
#ffffff ç™½
#840084 æš—ç´«
#00ff00 äº®ç»¿
#c6c6c6 äº®ç°
#008484 æµ…æš—è“
#ffff00 äº®é»„
#840000 æš—çº¢
#848484 æš—ç°
#0000ff äº®è“
#008400 æš—ç»¿
#ff00ff äº®ç´«
#848400 æš—é»„
```

æ‰€ä»¥æˆ‘ä»¬è¦ç»™`bootpack.c`æ·»åŠ å¾ˆå¤šä»£ç ã€‚

```c title="bootpack.c"
void io_hlt(void);
void io_cli(void);
void io_out8(int port, int data);
int io_load_eflags(void);
void io_store_eflags(int eflags);

//å°±ç®—å†™åœ¨åŒä¸€ä¸ªæºæ–‡ä»¶é‡Œï¼Œå¦‚æœæƒ³åœ¨å®šä¹‰å‰ä½¿ç”¨ï¼Œè¿˜æ˜¯å¿…é¡»äº‹å…ˆå£°æ˜ä¸€ä¸‹ã€‚
void init_palette(void);
void set_palette(int start, int end, unsigned char *rgb);

void HariMain(void)
{
	int i;
	char *p;

	init_palette();  //è®¾å®šè°ƒè‰²æ¿

	p = (char *) 0xa0000;

	for (i = 0; i <= 0xffff; i++)
	{
		p[i] = i & 0x0f;	
	}

	for (;;)
	{
		io_hlt();	
	}
}

void init_palette(void)
{
	static unsigned char table_rgb[16 * 3] = {
	0x00, 0x00, 0x00  //0:é»‘
	0xff, 0x00, 0x00  //1:äº®çº¢
	0x00, 0xff, 0x00  //2:äº®ç»¿
	0xff, 0xff, 0x00  //3:äº®é»„
	0x00, 0x00, 0xff  //4:äº®è“
	0xff, 0x00, 0xff  //5:äº®ç´«
	0x00, 0xff, 0xff  //6:æµ…äº®è“
	0xff, 0xff, 0xff  //7:ç™½
	0xc6, 0xc6, 0xc6  //8:äº®ç°
	0x84, 0x00, 0x00  //9:æš—çº¢
	0x00, 0x84, 0x00  //10:æš—ç»¿
	0x84, 0x84, 0x00  //11:æš—é»„
	0x00, 0x00, 0x84  //12:æš—é’
	0x84, 0x00, 0x84  //13:æš—ç´«
	0x00, 0x84, 0x84  //14:æµ…æš—è“
	0x84, 0x84, 0x84  //15:æš—ç°
	};
	set_palette(0, 15, table_rgb);
	return;
	//Cè¯­è¨€ä¸­çš„static charè¯­å¥åªèƒ½ç”¨äºæ•°æ®ï¼Œç›¸å½“äºæ±‡ç¼–ä¸­çš„DBæŒ‡ä»¤ã€‚
}

void set_palette(int start, int end, unsigned char *rgb)
{
	int i, eflags;
	eflags = io_load_eflags();  //è®°å½•ç»ˆç«¯è®¸å¯æ ‡å¿—çš„å€¼
	io_cli(); //å°†ä¸­æ–­è®¸å¯æ ‡å¿—ç½®ä¸º0ï¼Œç¦æ­¢ä¸­æ–­
	io_out8(0x03c8, start);
	for (i = start, i <= end; i++)
	{
		io_out8(0x03c9, rgb[0] / 4);
		io_out8(0x03c9, rgb[1] / 4);
		io_out8(0x03c9, rgb[2] / 4);
		rgb += 3;	
	}
	io_store_eflags(eflags); //å¤åŸä¸­æ–­è®¸å¯æ ‡å¿—
	return;
}
```

```c
char a[3];
```

Cè¯­è¨€ä¸­ï¼Œå¦‚æœè¿™æ ·å†™ï¼Œé‚£ä¹ˆ`a`å°±æˆä¸ºäº†***å¸¸æ•°***ï¼Œä»¥æ±‡ç¼–çš„è¯­è¨€è®²å°±æ˜¯***æ ‡è¯†ç¬¦***ã€‚==æ ‡è¯†ç¬¦çš„å€¼å½“ç„¶å°±æ„å‘³ç€åœ°å€==ã€‚

ä¸Šé¢çš„å™è¿°å°±ç›¸å½“äºæ±‡ç¼–é‡Œçš„è¿™ä¸ªè¯­å¥ï¼š

```nasm
a:
	RESB    3
```

`nask`ä¸­çš„`RESB`çš„å†…å®¹èƒ½å¤Ÿä¿è¯æ˜¯0ï¼Œä½†Cè¯­è¨€ä¸­ä¸èƒ½ä¿è¯ï¼Œæ‰€ä»¥é‡Œè¾¹è¯´ä¸å®šå«æœ‰æŸç§åƒåœ¾æ•°ã€‚

å°±åƒåœ¨æ±‡ç¼–è¯­è¨€ä¸­ç”¨`DB`æŒ‡ä»¤ä»£æ›¿`RESB`æŒ‡ä»¤é‚£æ ·ï¼Œåœ¨Cè¯­è¨€ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æŒ‡ç¤ºæ–¹æ³•ï¼Œé‚£å°±æ˜¯åœ¨å£°æ˜å‰åŠ ä¸Š`static`ã€‚

`usigned`çš„æ„æ€æ˜¯ï¼šè¿™é‡Œæ‰€å¤„ç†çš„æ•°æ®æ˜¯`BYTE`å‹ï¼Œä½†å®ƒæ˜¯æ²¡æœ‰ç¬¦å·çš„æ•°(0æˆ–æ­£æ•´æ•°)ã€‚

`char`å‹çš„å˜é‡æœ‰3ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯`signed`å‹ã€`unsigned`å‹å’ŒæœªæŒ‡å®šå‹ã€‚

å¯¹äº`char`æ¥è¯´ï¼Œ`signed`å‹èƒ½å¤Ÿå¤„ç†`-128~127`çš„æ•´æ•°ï¼Œ`unsigned`å‹èƒ½å¤Ÿå¤„ç†`0~255`çš„æ•´æ•°ã€‚æœªæŒ‡å®šå‹å¯ç”±ç¼–è¯‘å™¨å†³å®šæ˜¯`unsigned`è¿˜æ˜¯`signed`ã€‚

åœ¨è¿™ä¸ªç¨‹åºé‡Œï¼Œå¤šæ¬¡å‡ºç°`0xff`ï¼Œä¹Ÿå°±æ˜¯255ï¼Œå¦‚æœå®ƒè¢«è¯¯è§£ä¸ºè´Ÿæ•°å°±å¾ˆéº»çƒ¦ã€‚

æœ€åçš„å‡½æ•°`set_palette`ï¼Œä¸‹é¢æ˜¯ç²¾ç®€ç‰ˆï¼š

```c
void set_palette(int start, int end, unsigned char *rgb)
{
	int i;
	io_out8(0x03c8, start);
	for (i = start; i <= end; i++)
	{
		io_out8(0x03c9, rgb[0] / 4);
		io_out8(0x03c9, rgb[0] / 4);
		rgb += 3;	
	}

	return;
}
```

`io_out8`æ˜¯å¾€æŒ‡å®šè£…ç½®é‡Œä¼ é€æ•°æ®çš„å‡½æ•°ã€‚

### CPUä¸è®¾å¤‡ç›¸è¿

CPUçš„ç®¡è„šä¸ä»…ä¸å†…å­˜ç›¸è¿ï¼Œè¿˜ä¸å„ä¸ªè®¾å¤‡ç›¸è¿ï¼Œå¦‚å£°å¡ã€æ˜¾å¡ã€è½¯ç›˜ç­‰ç­‰ã€‚

CPUå‘è®¾å¤‡å‘é€ç”µä¿¡å·æ˜¯`OUT`æŒ‡ä»¤ï¼›ä»è®¾å¤‡å–å¾—ç”µä¿¡å·çš„æ˜¯`IN`æŒ‡ä»¤ã€‚

åœ¨`OUT`æŒ‡ä»¤å’Œ`IN`æŒ‡ä»¤ä¸­ï¼Œä¸ºäº†åŒºåˆ«ä¸åŒçš„è®¾å¤‡ï¼Œä¹Ÿè¦ä½¿ç”¨**è®¾å¤‡å·ç **ã€‚è®¾å¤‡å·ç åœ¨è‹±æ–‡ä¸­ç§°ä¸º`port`(ç«¯å£)ã€‚

åœ¨Cè¯­è¨€ä¸­ï¼Œæ²¡æœ‰ä¸`IN`å’Œ`OUT`æŒ‡ä»¤ç›¸å½“çš„è¯­å¥ï¼Œæ‰€ä»¥æˆ‘ä»¬åªå¥½æ‹¿æ±‡ç¼–è¯­è¨€æ¥åšäº†ğŸ¤”ã€‚

è®¾å¤‡å·ç `0x03c8`å’Œ`0x03c9`ï¼Œå¯ä»¥åœ¨osdevä¸­æŸ¥è¯¢[VGA](https://wiki.osdev.org/VGA_Hardware#VGA_Registers)ï¼š

> Port `0x3c8`, `0x3c9`, `0x3c7` control the DAC. Each register in the DAC consists of 18 bits, 6 bits for each color component. To write a color, write the color index to port `0x3c8`, then write 3 bytes to `0x3c9` in the order red, green, blue. If you want to write multiple consecutive DAC entries, you only need to write the first entry's index to 0x3c8 then write all values to `0x3c9` in the order of red, green, blue, red, green, blue, and so on. The accessed DAC entry will automatically increment after every 3 bytes written. To read the DAC entries, write the index to be read to `0x3c7`, then read the bytes from port `0x3c9` in a similar fashion (as with writing, the index will increment after every three bytes read).

### `CLI`å’Œ`STI` 

`CLI`å°†ä¸­æ–­æ ‡å¿—ç½®ä¸º0ï¼Œ`STI`å°†ä¸­æ–­æ ‡å¿—ç½®ä¸º1ã€‚å½“CPUé‡åˆ°ä¸­æ–­è¯·æ±‚æ—¶ï¼Œæ˜¯ç«‹å³å¤„ç†ä¸­æ–­è¯·æ±‚(ä¸­æ–­æ ‡å¿—ä¸º1)ï¼Œè¿˜æ˜¯å¿½ç•¥ä¸­æ–­è¯·æ±‚(ä¸­æ–­æ ‡å¿—ä¸º0)ï¼Œå°±ç”±è¿™ä¸ªä¸­æ–­æ ‡å¿—ä½æ¥è®¾å®šã€‚

### `EFLAGS`å¯„å­˜å™¨

è¿™æ˜¯ç”±åä¸º`FLAGS`çš„16ä½å¯„å­˜å™¨æ‰©å±•è€Œæ¥çš„32ä½å¯„å­˜å™¨ã€‚`FLAGS`æ˜¯å­˜å‚¨è¿›ä½æ ‡å¿—å’Œä¸­æ–­æ ‡å¿—ç­‰æ ‡å¿—çš„å¯„å­˜å™¨ã€‚è¿›ä½æ ‡å¿—å¯ä»¥é€šè¿‡`JC`æˆ–è€…`JNC`ç­‰è·³è½¬æŒ‡ä»¤æ¥ç®€å•åœ°åˆ¤æ–­åˆ°åº•æ˜¯0è¿˜æ˜¯1ã€‚

ä½†å¯¹äºä¸­æ–­æ ‡å¿—ï¼Œæ²¡æœ‰ç±»ä¼¼çš„`JI`æˆ–`JNI`å‘½ä»¤ï¼Œæ‰€ä»¥åªèƒ½è¯»å…¥`EFLAGS`ï¼Œå†æ£€æŸ¥ç¬¬9ä½æ˜¯0è¿˜æ˜¯1ã€‚

éšä¾¿è¯´ä¸€ä¸‹ï¼Œè¿›ä½æ ‡å¿—æ˜¯`EFLAGS`çš„ç¬¬0ä½ã€‚

### æ¢å¤ä¸­æ–­æ ‡å¿—

`set_palette`ä¸­æƒ³è¦åšçš„äº‹æƒ…æ˜¯åœ¨è®¾å®šè°ƒè‰²æ¿ä¹‹å‰é¦–å…ˆæ‰§è¡Œ`CLI`ï¼Œä½†å¤„ç†ç»“æŸä»¥åä¸€å®šè¦**æ¢å¤ä¸­æ–­æ ‡å¿—**ï¼Œå› æ­¤éœ€è¦è®°ä½æœ€å¼€å§‹çš„ä¸­æ–­æ ‡å¿—æ˜¯ä»€ä¹ˆã€‚

æ‰€ä»¥æˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ªå‡½æ•°`io_load_eflags`ï¼Œè¯»å–æœ€åˆçš„`eflags`å€¼ã€‚

```nasm title="naskfunc.nas"
[FORMAT "WCOFF"]
[INSTRSET "i486p"]
[BITS 32]
[FILE "naskfunc.nas"]

	GLOBAL _io_hlt, _io_cli, _io_stihlt
	GLOBAL _io_in8, _io_in16, _io_in32
	GLOBAL _io_out8, _io_out16, _io_out32
	GLOBAL _io_load_eflags, _io_store_eflags

[SECTION .text]

_io_hlt:       ; void io_hlt(void);
	HLT
	RET

_io_cli:       ; void io_cli(void);
	CLI
	RET

_io_sti:       ; void io_sti(void);
	STI
	RET

_io_stihlt:    ; void io_stihlt(void);
	STI
	HLT
	RET

_io_in8:       ; void io_in8(int port);
	MOV    EDX,[ESP+4]   ; port
	MOV    EAX,0
	IN     AL,DX
	RET

_io_in16:      ; int io_in16(int port);
	MOV    EDX,[ESP+4]   ; port
	MOV    EAX,0
	IN     AX,DX
	RET

_io_in32:      ; int io_in32(int port);
	MOV    EDX,[ESP+4]   ; port
	IN     EAX,DX
	RET

_io_out8:      ; void io_out8(int port, int data);
	MOV    EDX,[ESP+4]   ; port
	MOV    AL,[ESP+8]    ; data
	OUT    DX,AL
	RET

_io_out16:    ; void io_out16(int port, int data);
	MOV    EDX,[ESP+4]   ; port
	MOV    EAX,[ESP+8]   ; data
	OUT    DX,AX
	RET

_io_out32:    ; void io_out32(int port, int data);
	MOV    EDX,[ESP+4]   ; port
	MOV    EAX,[ESP+8]   ; data
	OUT    DX,EAX
	RET

_io_load_eflags:   ; int io_load_eflags(void);
	PUSHFD         ; æŒ‡PUSH EFLAGS
	POP    EAX
	RET

_io_store_eflags:  ; void io_store_eflags(int eflags);
	MOV    EAX,[ESP+4]
	PUSH   EAX
	POPFD          ; æŒ‡POP FLAGS
	RET
```

å¦‚æœæœ‰`MOV EAX,EFLAGS`ä¹‹ç±»çš„æŒ‡ä»¤å°±ç®€å•å¤šäº†ï¼Œä½†CPUæ²¡æœ‰è¿™ç§æŒ‡ä»¤ã€‚èƒ½å¤Ÿç”¨æ¥è¯»å†™`EFLAGS`çš„ï¼Œåªæœ‰`PUSHFD`å’Œ`POPFD`ã€‚

`PUSHFD`æ˜¯â€œpush flags double-wordâ€ï¼Œæ„æ€æ˜¯å°†æ ‡å¿—ä½çš„å€¼æŒ‰åŒå­—é•¿å‹å…¥æ ˆã€‚å…¶å®å®ƒèƒ½åšçš„ï¼Œæ— éå°±æ˜¯â€œPUSH EFLAGSâ€ã€‚

`POPFD`æ˜¯â€œpop flags double-wordâ€çš„ç¼©å†™ï¼Œæ„æ€æ˜¯æŒ‰åŒå­—èŠ‚é•¿å°†æ ‡å¿—ä½ä»æ ˆå¼¹å‡ºã€‚å®ƒæ‰€ä½œçš„ï¼Œå°±æ˜¯â€œPOP EFLAGS â€ã€‚

```nasm
PUSHFD
POP EAX
```

ä»£æ›¿äº†ï¼š

```nasm
MOV    EAX,EFLAGS
```

```nasm
PUSH    EAX
POPFD
```

ä»£æ›¿äº†ï¼š

```nasm
MOV    EFLAGS,EAX
```

### `EAX`æ˜¯è¿”å›å€¼

æœ€åè¦è®²çš„æ˜¯`io_load_eflags`ã€‚å®ƒå¯¹æˆ‘ä»¬è€Œè¨€ï¼Œæ˜¯ç¬¬ä¸€ä¸ªæœ‰è¿”å›å€¼çš„å‡½æ•°çš„ä¾‹å­ã€‚

æ ¹æ®Cè¯­è¨€çš„è§„çº¦ï¼Œæ‰§è¡Œ`RET`è¯­å¥æ—¶ï¼Œ`EAX`ä¸­çš„å€¼å°±è¢«çœ‹ä½œæ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚

##  ç»˜åˆ¶çŸ©å½¢

åœ¨å½“å‰ç”»é¢æ¨¡å¼ä¸­ï¼Œç”»é¢ä¸Šæœ‰`320x200 (=64000)`ä¸ªåƒç´ ã€‚

å‡è®¾åšå•†åº—çš„åæ ‡æ˜¯`(0,0)`ï¼Œå³ä¸‹ç‚¹çš„åæ ‡æ˜¯`(319,319)`ï¼Œé‚£ä¹ˆåƒç´ åæ ‡`(x,y)`å¯¹åº”çš„VRAMåœ°å€è®¡ç®—ï¼š

```txt
0xa0000 + x + y*320
```

å…¶ä»–ç”»é¢æ¨¡å¼ä¹ŸåŸºæœ¬ç›¸åŒï¼Œåªæ˜¯`0xa0000`è¿™ä¸ªèµ·å§‹åœ°å€å’Œyçš„ç³»æ•°`320`æœ‰äº›ä¸åŒã€‚

æ ¹æ®è¿™ç§æ€è·¯æˆ‘ä»¬åˆ¶ä½œäº†å‡½æ•°`boxfill8`ã€‚

```c title="bootpack.c"
void io_hlt(void);
void io_cli(void);
void io_out8(int port, int data);
int io_load_eflags(void);
void io_store_eflags(int eflags);

void init_palette(void);
void set_palette(int start, int end, unsigned char *rgb);
void boxfill8(unsigned char *vram, int xsize, unsigned char c, int x0, int y0, int x1, int y1);

#define COL8_000000 0
#define COL8_FF0000 1
#define COL8_00FF00 2
#define COL8_FFFF00 3
#define COL8_0000FF 4
#define COL8_FF00FF 5
#define COL8_00FFFF 6
#define COL8_FFFFFF 7
#define COL8_C6C6C6 8
#define COL8_840000 9
#define COL8_008400 10
#define COL8_848400 11
#define COL8_000084 12
#define COL8_840084 13
#define COL8_008484 14
#define COL8_848484 15

void HariMain(void)
{
	char *p;

	init_palette();

	p = (char *) 0xa0000;

	boxfill8(p, 320, COL8_FF0000, 20, 20, 120, 120);
	boxfill8(p, 320, COL8_00FF00, 70, 50, 170, 150);
	boxfill8(p, 320, COL8_0000FF, 120, 80, 220, 180);

	for (;;)
	{
		io_hlt();	
	}
}

void init_palette(void)
{
	static unsigned char table_rgb[16 * 3] = {
		0x00, 0x00, 0x00,
		0xff, 0x00, 0x00,
		0x00, 0xff, 0x00,
		0xff, 0xff, 0x00,
		0x00, 0x00, 0xff,
		0xff, 0x00, 0xff,
		0x00, 0xff, 0xff,
		0xff, 0xff, 0xff,
		0xc6, 0xc6, 0xc6,
		0x84, 0x00, 0x00,
		0x00, 0x84, 0x00,
		0x84, 0x84, 0x00,
		0x00, 0x00, 0x84,
		0x84, 0x00, 0x84,
		0x00, 0x84, 0x84,
		0x84, 0x84, 0x84	
	};
	set_palette(0, 15, table_rgb);
	return;
}

void set_palette(int start, int end, unsigned char *rgb)
{
	int i, eflags;
	eflags = io_load_eflags();
	io_cli();
	io_out8(0x03c8, start);
	for (i = start; i <= end; i++)
	{
		io_out8(0x03c9, rgb[0] / 4);
		io_out8(0x03c9, rgb[1] / 4);	
		io_out8(0x03c9, rgb[2] / 4);
		rgb += 3;
	}
	io_store_eflags(eflags);
	return;
}

void boxfill8(unsigned char *vram, int xsize, unsigned char c, int x0, int y0, int x1, int y1)
{
	int x, y;
	for (y = y0; y <= y1; y++)
	{
		for (x = x0; x <= x1; x++)
		{
			vram[y * xsize + x] = c;	
		}
	}
	return;
}
```

## ä»Šå¤©çš„æˆæœ

è¿™æ¬¡æˆ‘ä»¬åªä¿®æ”¹`HariMain`ç¨‹åºï¼š

```c
void HariMain(void)
{
	char *vram;
	int xsize, ysize;

	init_palette();
	vram = (char *) 0xa0000;
	xsize = 320;
	ysize = 200;

	boxfill8(vram, xsize, COL8_008484,  0,         0,          xsize -  1, ysize - 29);
	boxfill8(vram, xsize, COL8_C6C6C6,  0,         ysize - 28, xsize -  1, ysize - 28);
	boxfill8(vram, xsize, COL8_FFFFFF,  0,         ysize - 27, xsize -  1, ysize - 27);
	boxfill8(vram, xsize, COL8_C6C6C6,  0,         ysize - 26, xsize -  1, ysize -  1);

	boxfill8(vram, xsize, COL8_FFFFFF,  3,         ysize - 24, 59,         ysize - 24);
	boxfill8(vram, xsize, COL8_FFFFFF,  2,         ysize - 24,  2,         ysize -  4);
	boxfill8(vram, xsize, COL8_848484,  3,         ysize -  4, 59,         ysize -  4);
	boxfill8(vram, xsize, COL8_848484, 59,         ysize - 23, 59,         ysize -  5);
	boxfill8(vram, xsize, COL8_000000,  2,         ysize -  3, 59,         ysize -  3);
	boxfill8(vram, xsize, COL8_000000, 60,         ysize - 24, 60,         ysize -  3);

	boxfill8(vram, xsize, COL8_848484, xsize - 47, ysize - 24, xsize -  4, ysize - 24);
	boxfill8(vram, xsize, COL8_848484, xsize - 47, ysize - 23, xsize - 47, ysize -  4);
	boxfill8(vram, xsize, COL8_FFFFFF, xsize - 47, ysize -  3, xsize -  4, ysize -  3);
	boxfill8(vram, xsize, COL8_FFFFFF, xsize -  3, ysize - 24, xsize -  3, ysize -  3);

	for (;;)
	{
		io_hlt();	
	}
}
```

![image.png](https://vs-picbed-1320307070.cos.ap-nanjing.myqcloud.com/img/20240224161011.png)



